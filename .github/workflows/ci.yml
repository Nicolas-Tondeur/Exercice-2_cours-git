name: CI
on:
    push:
        branches:
        - dev
    pull_request:
        branches:
        - dev
jobs:
    build:
        runs-on: ubuntu-latest
        steps:
        - uses: actions/checkout@v3
        - name: Set up Python 3.11
          uses: actions/setup-python@v4
          with:
            python-version: '3.11'
        - name: Install dependencies
          run: |
            python -m pip install --upgrade pip
            pip install flake8 pytest
            if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        - name: Lint with flake8
          run: |
            # stop the build if there are Python syntax errors or undefined names
            flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
            # exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
            flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        - name: Test with pytest
          run: |
            pytest
        - name: Upload coverage to Codecov
          uses: codecov/codecov-action@v3
          with:
            token: ${{ secrets.CODECOV_TOKEN }}
            files: ./coverage.xml
            flags: unittests
            name: codecov-umbrella
            fail_ci_if_error: true
            verbose: true
        - name: Commit and push changes
          run: |
            git config --global user.name 'github-actions[bot]'
            git config --global user.email 'github-actions[bot]@users.noreply.github.com'
            git add .
            git commit -m "chore: update generated files" || echo "No changes to commit"
            git push origin HEAD:dev
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        - name: Create Pull Request
            uses: peter-evans/create-pull-request@v5
            with:
                token: ${{ secrets.GITHUB_TOKEN }}
                commit-message: chore: update generated files
                branch: update-generated-files
                title: chore: update generated files
                body: This PR updates the generated files.
                base: dev
                labels: automated-pr
                draft: false
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        - name: Notify on failure
          if: failure()
          uses: dawidd6/action-send-mail@v3
          with:
            server_address: smtp.example.com
            server_port: 587
            username: ${{ secrets.SMTP_USERNAME }}
            password: ${{ secrets.SMTP_PASSWORD }}
            subject: GitHub Actions CI Failure
            body: The CI workflow has failed. Please check the GitHub Actions logs for details.
            to:
                -
                    name: Dev Team
                    email:
                        ${{ secrets.NOTIFICATION_EMAIL }}
            from: github-actions[bot]@users.noreply.github.com
            secure: true # Use TLS
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        - name: Notify on success
          if: success()
          uses: dawidd6/action-send-mail@v3
          with:
            server_address: smtp.example.com
            server_port: 587
            username: ${{ secrets.SMTP_USERNAME }}
            password: ${{ secrets.SMTP_PASSWORD }}
            subject: GitHub Actions CI Success
            body: The CI workflow has completed successfully.
            to:
                -
                    name: Dev Team
                    email:
                        ${{ secrets.NOTIFICATION_EMAIL }}
            from: github-actions[bot]@users.noreply.github.com
            secure: true # Use TLS
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}